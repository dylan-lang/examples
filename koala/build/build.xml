<!--

$Id: build.xml,v 1.1 2002/08/09 23:04:04 andreas Exp $

Ant build file for the Koala HTTP server and associated libraries.

Since there's no Dylan compiler option for Ant (yet?) this is just
a way to copy files to the correct places after doing a build in
Functional Developer.

This is what the distributed directory structure is supposed to look like:
koala-x.y
  README.txt (always)
  bin        (always)
  build      (source distribution only)
  change-log.txt (always)
  config     (always)
  sources    (source distribution only)
  to-do.txt  (source distribution only)
  www        (always)

-->

<project name="koala" default="dist" basedir="../">

  <!-- set global properties for this build -->

  <!-- Set these both to the empty string if distributing a trunk version. -->
  <property name="version-prefix" value="-" />
  <property name="version" value="0.3" />

  <property name="sources" value="${basedir}/sources" />
  <property name="www"     value="${basedir}/www" />
  <property name="dist"    value="${basedir}/dist/koala${version-prefix}${version}" />
  <property name="config"  value="${basedir}/config" />


  <!-- ********** help ********** -->

  <target name="help">
    <echo message="" />
    <echo message="Usage: ant [target]" />
    <echo message="available targets are:" />
    <echo message="  dist [default] -- builds a full Koala distribution with source" />
    <echo message="  binary         -- builds a binary-only distribution" />
    <echo message="  source         -- builds a source-only distribution" />
    <echo message="  www            -- builds the Koala web pages" />
    <echo message="  clean-dist     -- deletes the distribution directory" />
    <echo message="  clean-binary   -- deletes compiler turds" />
    <echo message="  clean-source   -- deletes junk files (emacs turds etc) out of the source directories" />
    <echo message="  clean-all      -- calls all other clean-* targets" />
    <echo message="  help           -- display this help message" />
  </target>


  <!-- ********** dist ********** -->

  <target name="dist" depends="binary,source">
  </target>



  <!-- ********** www ********** -->

  <!-- Builds everything for the Koala download web pages.
       I actually put more in here than is accessible on the site,
       but it's not very big so it shouldn't matter.
    -->

  <target name="www">

    <mkdir dir="${dist}/www" />

    <copy todir="${dist}/www">
      <fileset dir="${www}" />
    </copy>

    <copy todir="${dist}/www/koala">
      <fileset dir="${basedir}"
               includes="change-log.txt" />
    </copy>
  </target>



  <!-- ********** common ********** -->

  <!-- Builds everything that goes in both the source and binary distributions. -->

  <target name="common" depends="www">

    <mkdir dir="${dist}" />
    <mkdir dir="${dist}/config" />

    <copy file="${basedir}/config/koala-config.xml"
          todir="${dist}/config"
          />

    <copy todir="${dist}">
      <fileset dir="${basedir}"
               includes="change-log.txt, README.txt" />
    </copy>

  </target>


  <!-- ********** binary ********** -->

  <target name="binary" depends="common">

    <mkdir dir="${dist}/bin" />

    <copy todir="${dist}/bin">
      <fileset dir="${sources}/example/release" />
    </copy>

    <copy todir="${dist}/bin">
      <fileset dir="${sources}/xml-rpc-client/release" />
    </copy>

  </target>


  <!-- ********** source-only ********** -->

  <target name="source" depends="common">

    <mkdir dir="${dist}/sources" />
    <mkdir dir="${dist}/build" />
    <mkdir dir="${dist}/lib" />
    
    <copy todir="${dist}/sources">
      <fileset dir="${basedir}/sources" includes="**/*.dylan, **/*.txt, **/*.lid, **/*.hdp, **/*.htm, **/*.html" />
    </copy>

    <copy todir="${dist}/lib">
      <fileset dir="${basedir}/lib" includes="**/*.dylan, **/*.txt, **/*.lid, **/*.hdp, **/*.htm, **/*.html" />
    </copy>

    <copy file="${basedir}/build/build.xml"
          todir="${dist}/build"
          />

    <copy file="${basedir}/to-do.txt"
          todir="${dist}"
          />

  </target>


  <!-- ********** cleanup targets ********** -->

  <target name="clean-all" depends="clean-dist, clean-source, clean-binary">
  </target>

  <target name="clean-dist">
    <delete dir="${basedir}/dist" />
  </target>

  <target name="clean-source">
    <delete>
      <fileset dir="${basedir}"
               defaultexcludes="no"
               includes="**/*~, **/#*#, **/.#*"
               />
    </delete>
  </target>

  <target name="clean-binary">
    <delete>
      <fileset dir="${sources}"
               includes="**/*-build/*, **/bin/*, **/lib/*, **/release/*"
               excludes="**/*.dylan, **/*.hdp, **/*.lid, **/*.txt, **/*.html, **/*.htm"
               />
    </delete>
  </target>

</project>
